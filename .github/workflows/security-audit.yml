name: ðŸ”’ AuditorÃ­a de Seguridad

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Ejecutar cada lunes a las 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  security-audit:
    name: AuditorÃ­a de Seguridad Completa
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ˜ Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql
          tools: composer:v2

      - name: ðŸ“¦ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: ðŸ” AuditorÃ­a de dependencias (Composer Audit)
        run: |
          echo "ðŸ” Ejecutando auditorÃ­a de dependencias..."
          composer audit --format=plain || true
          echo "âœ… AuditorÃ­a de dependencias completada"
        continue-on-error: true

      - name: ðŸ›¡ï¸ AnÃ¡lisis estÃ¡tico con PHPStan
        run: |
          echo "ðŸ”§ Instalando PHPStan..."
          composer require --dev phpstan/phpstan --no-interaction
          
          echo "ðŸ” Ejecutando anÃ¡lisis estÃ¡tico..."
          vendor/bin/phpstan analyse src/ --level=5 --no-progress || true
          echo "âœ… AnÃ¡lisis estÃ¡tico completado"
        continue-on-error: true

      - name: ðŸ” Escaneo de secretos hardcodeados
        run: |
          echo "ðŸ” Buscando posibles secretos hardcodeados..."
          
          # Buscar patrones comunes de secretos
          PATTERNS=(
            "password.*=.*['\"][^'\"]+['\"]"     # password = "..."
            "api_key.*=.*['\"][^'\"]+['\"]"     # api_key = "..."
            "secret.*=.*['\"][^'\"]+['\"]"      # secret = "..."
            "token.*=.*['\"][^'\"]+['\"]"       # token = "..."
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rniE "$pattern" --include="*.php" --exclude-dir=vendor --exclude-dir=tests . 2>/dev/null; then
              echo "âš ï¸ Posible secreto encontrado con patrÃ³n: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 0 ]; then
            echo "âœ… No se encontraron secretos hardcodeados obvios"
          fi
        continue-on-error: true

      - name: ðŸ•³ï¸ Verificar funciones peligrosas
        run: |
          echo "ðŸ” Buscando funciones potencialmente peligrosas..."
          
          # Funciones peligrosas a buscar
          DANGEROUS_FUNCS="eval|exec|shell_exec|system|passthru|popen|proc_open|pcntl_exec|assert"
          
          if grep -rniE "\b($DANGEROUS_FUNCS)\s*\(" --include="*.php" --exclude-dir=vendor --exclude-dir=tests . 2>/dev/null; then
            echo "âš ï¸ Se encontraron funciones potencialmente peligrosas. Revisar manualmente."
          else
            echo "âœ… No se encontraron funciones peligrosas"
          fi
        continue-on-error: true

      - name: ðŸ” Verificar configuraciÃ³n de seguridad
        run: |
          echo "ðŸ” Verificando configuraciÃ³n de seguridad..."
          
          # Verificar que display_errors estÃ¡ desactivado en producciÃ³n
          if grep -rni "display_errors.*On" --include="*.php" --exclude-dir=vendor . 2>/dev/null; then
            echo "âš ï¸ display_errors podrÃ­a estar activado"
          else
            echo "âœ… display_errors no estÃ¡ activado explÃ­citamente"
          fi
          
          # Verificar uso de prepared statements
          if grep -rni "\$pdo->query.*\$" --include="*.php" --exclude-dir=vendor . 2>/dev/null; then
            echo "âš ï¸ Posible uso de query() con variables (revisar SQL injection)"
          else
            echo "âœ… No se detectÃ³ uso obvio de query() con variables"
          fi
          
          # Verificar htmlspecialchars/htmlentities
          if grep -rni "echo.*\$_" --include="*.php" --exclude-dir=vendor --exclude-dir=tests . 2>/dev/null; then
            echo "âš ï¸ Posible echo directo de variables $_GET/$_POST (revisar XSS)"
          else
            echo "âœ… No se detectÃ³ echo directo de superglobales"
          fi

      - name: ðŸ“Š Generar reporte de seguridad
        run: |
          echo "ðŸ“Š Reporte de Seguridad - $(date)" > security-report.txt
          echo "=========================================" >> security-report.txt
          echo "" >> security-report.txt
          
          echo "## Dependencias" >> security-report.txt
          composer audit --format=plain 2>&1 >> security-report.txt || echo "No se encontraron vulnerabilidades conocidas" >> security-report.txt
          echo "" >> security-report.txt
          
          echo "## Archivos PHP analizados" >> security-report.txt
          find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*" | wc -l >> security-report.txt
          echo "" >> security-report.txt
          
          cat security-report.txt

      - name: ðŸ“¤ Subir reporte de seguridad
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.txt
          retention-days: 30
