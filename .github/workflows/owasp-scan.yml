name: OWASP Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  code-security:
    name: Analisis de Codigo de Seguridad
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, openssl, sodium

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Verificar configuracion de seguridad PHP
        run: |
          echo "Verificando configuraciones de seguridad..."
          grep -rni "display_errors.*on" --include="*.php" --exclude-dir=vendor . || echo "display_errors no habilitado"
          grep -rni "error_reporting\s*(\s*-1\s*)" --include="*.php" --exclude-dir=vendor . || echo "error_reporting OK"

      - name: Verificar proteccion CSRF
        run: |
          echo "Verificando proteccion CSRF en formularios..."
          for file in $(find . -name "*.php" -not -path "./vendor/*" 2>/dev/null); do
            if grep -q "method=.POST" "$file" 2>/dev/null; then
              if ! grep -q "csrf_token" "$file" 2>/dev/null; then
                echo "Posible falta de CSRF en: $file"
              fi
            fi
          done
          echo "Verificacion CSRF completada"

      - name: Verificar Prepared Statements
        run: |
          echo "Buscando posibles consultas SQL inseguras..."
          grep -rniE "(query|exec)\s*\(\s*[\"'].*\$" --include="*.php" --exclude-dir=vendor . || echo "No se encontraron queries inseguras"
          PREPARE_COUNT=$(grep -rni "prepare\s*(" --include="*.php" --exclude-dir=vendor . 2>/dev/null | wc -l)
          echo "Prepared statements encontrados: $PREPARE_COUNT"

      - name: Verificar hashing de contrasenas
        run: |
          echo "Verificando manejo de contrasenas..."
          if grep -rni "password_hash\|CryptoFortress" --include="*.php" --exclude-dir=vendor . > /dev/null 2>&1; then
            echo "password_hash o CryptoFortress encontrado"
          else
            echo "ADVERTENCIA: No se encontro password_hash() ni CryptoFortress"
          fi
          if grep -rniE "md5\s*\(|sha1\s*\(" --include="*.php" --exclude-dir=vendor . 2>/dev/null | grep -i password; then
            echo "ERROR: Se encontraron hashes debiles para contrasenas"
          else
            echo "No se encontraron hashes debiles para contrasenas"
          fi

      - name: Generar resumen de seguridad
        run: |
          echo "# Resumen de Seguridad - StatTracker" > security-summary.md
          echo "Fecha: $(date -u)" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Clases de Seguridad" >> security-summary.md
          for class in Security SecurityHeaders SecurityAudit SecurityFirewall SessionManager InputSanitizer RateLimiter CryptoFortress SupplyChainGuard UltimateShield; do
            if [ -f "src/${class}.php" ]; then
              echo "- ${class}.php presente" >> security-summary.md
            else
              echo "- ${class}.php NO encontrado" >> security-summary.md
            fi
          done
          echo "" >> security-summary.md
          echo "## Archivos .htaccess" >> security-summary.md
          for htaccess in .htaccess src/.htaccess logs/.htaccess uploads/.htaccess; do
            if [ -f "$htaccess" ]; then
              echo "- ${htaccess} presente" >> security-summary.md
            else
              echo "- ${htaccess} NO encontrado" >> security-summary.md
            fi
          done
          cat security-summary.md

      - name: Subir resumen
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 30
