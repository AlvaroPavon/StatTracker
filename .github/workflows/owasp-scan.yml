name: ðŸ”’ OWASP Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Ejecutar cada domingo a las 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  owasp-scan:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ˜ Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql

      - name: ðŸ“¦ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: ðŸ” OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'StatTracker'
          path: '.'
          format: 'HTML'
          args: >-
            --scan "./**/*.php"
            --scan "./**/*.js"
            --scan "./composer.json"
            --scan "./composer.lock"
            --exclude "**/vendor/**"
            --exclude "**/node_modules/**"
            --failOnCVSS 8
            --enableRetired
        continue-on-error: true

      - name: ðŸ“¤ Subir reporte OWASP
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports/
          retention-days: 30

  code-security:
    name: AnÃ¡lisis de CÃ³digo de Seguridad
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ˜ Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: ðŸ“¦ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: ðŸ” Verificar configuraciÃ³n de seguridad PHP
        run: |
          echo "ðŸ” Verificando configuraciones de seguridad..."
          
          # Buscar display_errors habilitado
          if grep -rni "display_errors.*on" --include="*.php" --exclude-dir=vendor . 2>/dev/null; then
            echo "âš ï¸ ADVERTENCIA: display_errors puede estar habilitado"
          else
            echo "âœ… display_errors no estÃ¡ habilitado explÃ­citamente"
          fi
          
          # Buscar error_reporting muy permisivo sin control
          if grep -rni "error_reporting\s*\(\s*-1\s*\)" --include="*.php" --exclude-dir=vendor . 2>/dev/null; then
            echo "âš ï¸ ADVERTENCIA: error_reporting muy permisivo encontrado"
          else
            echo "âœ… error_reporting configurado correctamente"
          fi

      - name: ðŸ›¡ï¸ Verificar protecciÃ³n CSRF
        run: |
          echo "ðŸ” Verificando protecciÃ³n CSRF en formularios..."
          
          # Buscar formularios POST sin CSRF
          for file in $(find . -name "*.php" -not -path "./vendor/*"); do
            if grep -l "method=[\"']POST" "$file" > /dev/null 2>&1; then
              if ! grep -l "csrf_token" "$file" > /dev/null 2>&1; then
                echo "âš ï¸ Posible falta de CSRF en: $file"
              fi
            fi
          done
          echo "âœ… VerificaciÃ³n CSRF completada"

      - name: ðŸ”’ Verificar Prepared Statements
        run: |
          echo "ðŸ” Buscando posibles consultas SQL inseguras..."
          
          # Buscar concatenaciÃ³n directa en queries
          if grep -rniE "(query|exec)\s*\(\s*[\"'].*\\\$" --include="*.php" --exclude-dir=vendor . 2>/dev/null; then
            echo "âš ï¸ ADVERTENCIA: Posibles queries con concatenaciÃ³n de variables"
          else
            echo "âœ… No se encontraron queries con concatenaciÃ³n directa"
          fi
          
          # Verificar uso de prepare()
          PREPARE_COUNT=$(grep -rni "prepare\s*(" --include="*.php" --exclude-dir=vendor . 2>/dev/null | wc -l)
          echo "ðŸ“Š Prepared statements encontrados: $PREPARE_COUNT"

      - name: ðŸ”‘ Verificar hashing de contraseÃ±as
        run: |
          echo "ðŸ” Verificando manejo de contraseÃ±as..."
          
          # Buscar password_hash
          if grep -rni "password_hash" --include="*.php" --exclude-dir=vendor . > /dev/null 2>&1; then
            echo "âœ… password_hash() estÃ¡ siendo utilizado"
          else
            echo "âš ï¸ ADVERTENCIA: No se encontrÃ³ password_hash()"
          fi
          
          # Buscar algoritmos dÃ©biles
          if grep -rniE "md5\s*\(|sha1\s*\(" --include="*.php" --exclude-dir=vendor . 2>/dev/null | grep -i password; then
            echo "âŒ ERROR: Se encontraron hashes dÃ©biles para contraseÃ±as"
            exit 1
          else
            echo "âœ… No se encontraron hashes dÃ©biles para contraseÃ±as"
          fi

      - name: ðŸ“Š Generar resumen de seguridad
        run: |
          echo "# ðŸ“Š Resumen de Seguridad - StatTracker" > security-summary.md
          echo "Fecha: $(date -u)" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Clases de Seguridad" >> security-summary.md
          for class in Security SecurityHeaders SecurityAudit SecurityFirewall SessionManager InputSanitizer RateLimiter; do
            if [ -f "src/${class}.php" ]; then
              echo "- âœ… ${class}.php presente" >> security-summary.md
            else
              echo "- âŒ ${class}.php NO encontrado" >> security-summary.md
            fi
          done
          
          echo "" >> security-summary.md
          echo "## Archivos .htaccess" >> security-summary.md
          for htaccess in .htaccess src/.htaccess logs/.htaccess uploads/.htaccess; do
            if [ -f "$htaccess" ]; then
              echo "- âœ… ${htaccess} presente" >> security-summary.md
            else
              echo "- âš ï¸ ${htaccess} NO encontrado" >> security-summary.md
            fi
          done
          
          cat security-summary.md

      - name: ðŸ“¤ Subir resumen
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 30
