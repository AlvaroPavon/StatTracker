name: Supply Chain Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  dependency-audit:
    name: Auditoria de Dependencias
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, openssl, sodium

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Composer Audit
        run: |
          echo "Ejecutando auditoria de Composer..."
          composer audit --format=plain || echo "Auditoria completada"
        continue-on-error: true

      - name: Verificar hashes de dependencias
        run: |
          echo "Verificando integridad de composer.lock..."
          if [ -f composer.lock ]; then
            composer validate --strict || echo "Validacion completada con advertencias"
            echo "composer.lock validado"
          else
            echo "composer.lock no encontrado"
          fi
        continue-on-error: true

      - name: Escanear codigo malicioso en vendor
        run: |
          echo "Escaneando vendor/ en busca de codigo sospechoso..."
          if [ -d vendor ]; then
            grep -rniE "eval\s*\(" vendor/ --include="*.php" 2>/dev/null | grep -v test | grep -v Test | head -5 || true
            grep -rniE "exec\s*\(" vendor/ --include="*.php" 2>/dev/null | grep -v test | grep -v Test | head -5 || true
            grep -rniE "shell_exec\s*\(" vendor/ --include="*.php" 2>/dev/null | grep -v test | grep -v Test | head -5 || true
          fi
          echo "Escaneo completado"
        continue-on-error: true

      - name: Listar dependencias
        run: |
          echo "Dependencias instaladas:"
          composer show --direct || echo "No se pudieron listar dependencias"

  hash-verification:
    name: Verificacion de Hashes
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, openssl

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Generar hashes de archivos criticos
        run: |
          echo "Generando hashes SHA384 de archivos criticos..."
          echo "=== Archivos de la aplicacion ===" > file_hashes.txt
          for file in security_init.php database_connection.php index.php login.php register.php logout.php .htaccess; do
            if [ -f "$file" ]; then
              HASH=$(sha384sum "$file" | cut -d' ' -f1)
              echo "$file: $HASH" >> file_hashes.txt
              echo "$file OK"
            fi
          done
          echo "" >> file_hashes.txt
          echo "=== Clases de seguridad ===" >> file_hashes.txt
          for file in src/Security*.php src/Crypto*.php src/Supply*.php src/Ultimate*.php; do
            if [ -f "$file" ]; then
              HASH=$(sha384sum "$file" | cut -d' ' -f1)
              echo "$file: $HASH" >> file_hashes.txt
              echo "$file OK"
            fi
          done
          cat file_hashes.txt

      - name: Subir hashes
        uses: actions/upload-artifact@v4
        with:
          name: file-hashes
          path: file_hashes.txt
          retention-days: 90

  license-check:
    name: Verificacion de Licencias
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Verificar licencias
        run: |
          echo "Verificando licencias de dependencias..."
          composer licenses || echo "No se pudieron verificar licencias"
          echo ""
          echo "Licencias a revisar manualmente:"
          composer licenses 2>/dev/null | grep -iE "GPL|AGPL|proprietary" || echo "No se encontraron licencias problematicas"

  crypto-verification:
    name: Verificacion Criptografica
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, openssl, sodium

      - name: Verificar algoritmos criptograficos
        run: |
          php -r "
          echo 'Verificacion de algoritmos criptograficos' . PHP_EOL;
          echo str_repeat('=', 50) . PHP_EOL;
          
          // Verificar extensiones
          \$extensions = ['openssl', 'sodium', 'hash'];
          foreach (\$extensions as \$ext) {
              echo \$ext . ': ' . (extension_loaded(\$ext) ? 'OK' : 'FALTA') . PHP_EOL;
          }
          
          echo PHP_EOL . 'Algoritmos de hash disponibles:' . PHP_EOL;
          \$required = ['sha256', 'sha384', 'sha512', 'sha3-256', 'sha3-512'];
          foreach (\$required as \$algo) {
              echo \$algo . ': ' . (in_array(\$algo, hash_algos()) ? 'OK' : 'FALTA') . PHP_EOL;
          }
          
          echo PHP_EOL . 'Algoritmos de cifrado disponibles:' . PHP_EOL;
          \$ciphers = ['aes-256-gcm', 'aes-256-cbc', 'chacha20-poly1305'];
          foreach (\$ciphers as \$cipher) {
              echo \$cipher . ': ' . (in_array(\$cipher, openssl_get_cipher_methods()) ? 'OK' : 'FALTA') . PHP_EOL;
          }
          
          echo PHP_EOL . 'Password hashing:' . PHP_EOL;
          echo 'PASSWORD_BCRYPT: OK' . PHP_EOL;
          echo 'PASSWORD_ARGON2ID: ' . (defined('PASSWORD_ARGON2ID') ? 'OK' : 'NO DISPONIBLE') . PHP_EOL;
          
          echo PHP_EOL . 'Verificacion criptografica completada' . PHP_EOL;
          "
