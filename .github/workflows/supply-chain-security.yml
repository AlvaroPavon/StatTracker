name: üîó Supply Chain Security

on:
  push:
    branches: [main, develop]
    paths:
      - 'composer.json'
      - 'composer.lock'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [main]
  schedule:
    # Ejecutar diariamente a las 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  dependency-audit:
    name: Auditor√≠a de Dependencias
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v4

      - name: üêò Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, openssl, sodium

      - name: üì¶ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: üîç Composer Audit
        run: |
          echo "üîç Ejecutando auditor√≠a de Composer..."
          composer audit --format=plain
          echo "‚úÖ Auditor√≠a de Composer completada"
        continue-on-error: false

      - name: üîê Verificar hashes de dependencias
        run: |
          echo "üîç Verificando integridad de composer.lock..."
          
          # Verificar que composer.lock existe y es v√°lido
          if [ ! -f composer.lock ]; then
            echo "‚ùå composer.lock no encontrado"
            exit 1
          fi
          
          # Verificar que los hashes coinciden
          composer validate --strict
          
          echo "‚úÖ composer.lock v√°lido"

      - name: üõ°Ô∏è Escanear c√≥digo malicioso en vendor/
        run: |
          echo "üîç Escaneando vendor/ en busca de c√≥digo sospechoso..."
          
          # Patrones peligrosos
          PATTERNS=(
            "eval\s*\("
            "exec\s*\("
            "shell_exec\s*\("
            "system\s*\("
            "passthru\s*\("
            "base64_decode\s*\("
            "\\$_GET\s*\["
            "\\$_POST\s*\["
            "\\$_REQUEST\s*\["
            "file_get_contents\s*\(\s*['\"]http"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            echo "Buscando: $pattern"
            if grep -rniE "$pattern" vendor/ --include="*.php" 2>/dev/null | grep -v "test" | grep -v "Test" | head -5; then
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "‚ö†Ô∏è Se encontraron patrones sospechosos. Revisar manualmente."
          else
            echo "‚úÖ No se encontraron patrones obviamente maliciosos"
          fi

      - name: üìã Listar dependencias
        run: |
          echo "üì¶ Dependencias instaladas:"
          composer show --direct

  hash-verification:
    name: Verificaci√≥n de Hashes
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v4

      - name: üêò Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, openssl

      - name: üì¶ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: üîê Generar hashes de archivos cr√≠ticos
        run: |
          echo "üîç Generando hashes SHA384 de archivos cr√≠ticos..."
          echo ""
          echo "=== Archivos de la aplicaci√≥n ===" > file_hashes.txt
          
          FILES=(
            "security_init.php"
            "database_connection.php"
            "index.php"
            "login.php"
            "register.php"
            "logout.php"
            ".htaccess"
          )
          
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              HASH=$(sha384sum "$file" | cut -d' ' -f1)
              echo "$file: $HASH" >> file_hashes.txt
              echo "‚úÖ $file"
            fi
          done
          
          echo "" >> file_hashes.txt
          echo "=== Clases de seguridad ===" >> file_hashes.txt
          
          for file in src/Security*.php src/Crypto*.php src/Supply*.php; do
            if [ -f "$file" ]; then
              HASH=$(sha384sum "$file" | cut -d' ' -f1)
              echo "$file: $HASH" >> file_hashes.txt
              echo "‚úÖ $file"
            fi
          done
          
          echo ""
          cat file_hashes.txt

      - name: üì§ Subir hashes
        uses: actions/upload-artifact@v4
        with:
          name: file-hashes
          path: file_hashes.txt
          retention-days: 90

  license-check:
    name: Verificaci√≥n de Licencias
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v4

      - name: üêò Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: üì¶ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: üìú Verificar licencias
        run: |
          echo "üìú Verificando licencias de dependencias..."
          composer licenses
          
          echo ""
          echo "‚ö†Ô∏è Licencias a revisar manualmente:"
          composer licenses | grep -iE "GPL|AGPL|proprietary" || echo "‚úÖ No se encontraron licencias problem√°ticas"

  crypto-verification:
    name: Verificaci√≥n Criptogr√°fica
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v4

      - name: üêò Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, openssl, sodium

      - name: üîê Verificar algoritmos criptogr√°ficos
        run: |
          php -r "
          echo 'üîê Verificaci√≥n de algoritmos criptogr√°ficos' . PHP_EOL;
          echo str_repeat('=', 50) . PHP_EOL;
          
          // Verificar extensiones
          \$extensions = ['openssl', 'sodium', 'hash'];
          foreach (\$extensions as \$ext) {
              echo (\$ext . ': ' . (extension_loaded(\$ext) ? '‚úÖ' : '‚ùå')) . PHP_EOL;
          }
          
          echo PHP_EOL . 'Algoritmos de hash disponibles:' . PHP_EOL;
          \$required = ['sha256', 'sha384', 'sha512', 'sha3-256', 'sha3-512'];
          foreach (\$required as \$algo) {
              echo (\$algo . ': ' . (in_array(\$algo, hash_algos()) ? '‚úÖ' : '‚ùå')) . PHP_EOL;
          }
          
          echo PHP_EOL . 'Algoritmos de cifrado disponibles:' . PHP_EOL;
          \$ciphers = ['aes-256-gcm', 'aes-256-cbc', 'chacha20-poly1305'];
          foreach (\$ciphers as \$cipher) {
              echo (\$cipher . ': ' . (in_array(\$cipher, openssl_get_cipher_methods()) ? '‚úÖ' : '‚ùå')) . PHP_EOL;
          }
          
          echo PHP_EOL . 'Password hashing:' . PHP_EOL;
          echo ('PASSWORD_BCRYPT: ‚úÖ') . PHP_EOL;
          echo ('PASSWORD_ARGON2ID: ' . (defined('PASSWORD_ARGON2ID') ? '‚úÖ' : '‚ùå')) . PHP_EOL;
          
          echo PHP_EOL . 'Generaci√≥n de n√∫meros aleatorios:' . PHP_EOL;
          try {
              \$random = random_bytes(32);
              echo ('random_bytes: ‚úÖ (' . strlen(\$random) . ' bytes)') . PHP_EOL;
          } catch (Exception \$e) {
              echo ('random_bytes: ‚ùå') . PHP_EOL;
          }
          
          echo PHP_EOL . '‚úÖ Verificaci√≥n criptogr√°fica completada' . PHP_EOL;
          "
