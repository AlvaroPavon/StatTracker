name: ðŸ“¦ Crear Release de ProducciÃ³n

# Se activa cuando publicas un release desde GitHub Desktop o Web
on:
  release:
    types: [published]

jobs:
  build-and-release:
    name: Construir y Publicar Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Descargar cÃ³digo fuente
        uses: actions/checkout@v4

      - name: ðŸ˜ Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql
          coverage: none

      - name: ðŸ“‹ Obtener versiÃ³n del release
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ðŸ”§ Instalar dependencias de producciÃ³n
        run: |
          composer install --no-dev --optimize-autoloader --prefer-dist --no-interaction --no-progress
          echo "âœ… Dependencias de producciÃ³n instaladas"

      - name: ðŸ§¹ Limpiar archivos de desarrollo
        run: |
          echo "ðŸ—‘ï¸ Eliminando archivos de desarrollo..."
          
          # Directorios de desarrollo
          rm -rf tests/
          rm -rf docs/
          rm -rf coverage/
          rm -rf .github/
          rm -rf .git/
          rm -rf .phpunit.cache/
          rm -rf node_modules/
          
          # Archivos de configuraciÃ³n de desarrollo
          rm -f phpunit.xml
          rm -f composer.lock
          rm -f package.json
          rm -f package-lock.json
          rm -f .gitignore
          rm -f .gitattributes
          rm -f .editorconfig
          rm -f .php-cs-fixer.php
          rm -f phpstan.neon
          rm -f phpstan.neon.dist
          
          # DocumentaciÃ³n solo de desarrollo
          rm -f CUMPLIMIENTO_REQUISITOS.md
          
          # Crear directorio uploads vacÃ­o con .gitkeep
          mkdir -p uploads
          touch uploads/.gitkeep
          
          # Eliminar archivos de ejemplo o test en uploads
          find uploads -type f ! -name '.gitkeep' -delete 2>/dev/null || true
          
          echo "âœ… Archivos de desarrollo eliminados"

      - name: ðŸ“ Crear archivo de versiÃ³n
        run: |
          echo "${{ steps.version.outputs.tag }}" > VERSION
          echo "Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> VERSION
          echo "âœ… Archivo VERSION creado"

      - name: ðŸ“¦ Crear archivo ZIP de producciÃ³n
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          ZIP_NAME="StatTracker-${VERSION}.zip"
          
          # Crear ZIP excluyendo archivos ocultos residuales
          zip -r "$ZIP_NAME" . \
            -x "*.git*" \
            -x "*.DS_Store" \
            -x "*Thumbs.db" \
            -x "*.log"
          
          echo "âœ… Archivo $ZIP_NAME creado"
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
        id: zip

      - name: ðŸ“¤ Subir archivo al Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.zip.outputs.zip_name }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release completado
        run: |
          echo "ðŸŽ‰ Release ${{ steps.version.outputs.tag }} publicado exitosamente!"
          echo "ðŸ“¦ Archivo: ${{ steps.zip.outputs.zip_name }}"
