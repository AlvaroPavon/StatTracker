name: Crear Release de Produccion

on:
  release:
    types: [published]

jobs:
  build-and-release:
    name: Construir y Publicar Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Descargar codigo fuente
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql, openssl, sodium
          coverage: none

      - name: Obtener version del release
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Instalar dependencias de produccion
        run: |
          composer install --no-dev --optimize-autoloader --prefer-dist --no-interaction --no-progress
          echo "Dependencias de produccion instaladas"

      - name: Limpiar archivos de desarrollo
        run: |
          echo "Eliminando archivos de desarrollo..."
          rm -rf tests/ docs/ coverage/ .github/ .git/ .phpunit.cache/ node_modules/ || true
          rm -f phpunit.xml composer.lock package.json package-lock.json .gitignore .gitattributes .editorconfig .php-cs-fixer.php phpstan.neon phpstan.neon.dist CUMPLIMIENTO_REQUISITOS.md || true
          mkdir -p uploads
          touch uploads/.gitkeep
          find uploads -type f ! -name '.gitkeep' -delete 2>/dev/null || true
          echo "Archivos de desarrollo eliminados"

      - name: Crear archivo de version
        run: |
          echo "${{ steps.version.outputs.tag }}" > VERSION
          echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> VERSION
          echo "Archivo VERSION creado"

      - name: Crear archivo ZIP de produccion
        id: zip
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          ZIP_NAME="StatTracker-${VERSION}.zip"
          zip -r "$ZIP_NAME" . -x "*.git*" -x "*.DS_Store" -x "*Thumbs.db" -x "*.log"
          echo "Archivo $ZIP_NAME creado"
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Subir archivo al Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.zip.outputs.zip_name }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release completado
        run: |
          echo "Release ${{ steps.version.outputs.tag }} publicado exitosamente!"
          echo "Archivo: ${{ steps.zip.outputs.zip_name }}"
