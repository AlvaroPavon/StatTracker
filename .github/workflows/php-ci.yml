name: PHP CI (Tests + Coverage)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    name: Tests y Cobertura
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: testing_db
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, pdo_mysql, pdo_sqlite, sqlite3, openssl, sodium
          coverage: xdebug

      - name: Instalar cliente MySQL
        run: sudo apt-get update && sudo apt-get install -y mysql-client

      - name: Esperar a MySQL
        run: |
          for i in {1..30}; do
            if mysql -h 127.0.0.1 -P 3306 -u root -e "SELECT 1" 2>/dev/null; then
              echo "MySQL listo"
              break
            fi
            echo "Esperando a MySQL... intento $i"
            sleep 2
          done

      - name: Importar esquema de base de datos
        run: |
          if [ -f database.sql ]; then
            mysql -h 127.0.0.1 -P 3306 -u root testing_db < database.sql
            echo "Esquema importado"
          else
            echo "No se encontro database.sql, continuando..."
          fi

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Verificar sintaxis PHP
        run: |
          echo "Verificando sintaxis PHP..."
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l 2>&1 | grep -v "No syntax errors" || true
          echo "Verificacion completada"

      - name: Ejecutar Tests
        run: |
          if [ -f vendor/bin/phpunit ]; then
            chmod +x vendor/bin/phpunit
            vendor/bin/phpunit --colors=always || true
          else
            echo "PHPUnit no encontrado, saltando tests"
          fi
        continue-on-error: true

  lint:
    name: Analisis de Codigo
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Verificar sintaxis PHP
        run: |
          echo "Verificando sintaxis PHP..."
          error_found=0
          while IFS= read -r -d '' file; do
            if ! php -l "$file" 2>&1 | grep -q "No syntax errors"; then
              echo "Error en: $file"
              error_found=1
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -print0)
          if [ $error_found -eq 1 ]; then
            echo "Se encontraron errores de sintaxis"
            exit 1
          fi
          echo "Sintaxis PHP correcta"
