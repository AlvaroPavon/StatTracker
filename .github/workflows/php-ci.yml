name: üß™ PHP CI (Tests + Coverage)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  DB_HOST: 127.0.0.1
  DB_DATABASE: testing_db
  DB_USERNAME: root
  DB_PASSWORD: ''
  MYSQL_PORT: 3306

jobs:
  test:
    name: Tests y Cobertura
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: ${{ env.DB_DATABASE }}
          MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v4

      - name: üêò Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, pdo_mysql, pdo_sqlite, sqlite3
          coverage: xdebug

      - name: üîß Instalar cliente MySQL
        run: sudo apt-get update && sudo apt-get install -y mysql-client

      - name: ‚è≥ Esperar a MySQL
        run: |
          while ! mysql -h 127.0.0.1 -P ${{ env.MYSQL_PORT }} -u ${{ env.DB_USERNAME }} -e "quit" 2>/dev/null; do
            echo "Esperando a MySQL..."
            sleep 1
          done
          echo "‚úÖ MySQL est√° listo"

      - name: üóÉÔ∏è Importar esquema de base de datos
        run: |
          mysql -h 127.0.0.1 -P ${{ env.MYSQL_PORT }} -u ${{ env.DB_USERNAME }} ${{ env.DB_DATABASE }} < database.sql
          echo "‚úÖ Esquema importado"

      - name: üì¶ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: üîê Dar permisos de ejecuci√≥n a PHPUnit
        run: chmod +x vendor/bin/phpunit

      - name: üß™ Ejecutar Tests con Cobertura
        run: |
          echo "üß™ Ejecutando tests..."
          vendor/bin/phpunit --coverage-html coverage --coverage-text --colors=always
          echo "‚úÖ Tests completados"

      - name: üìä Subir reporte de cobertura
        if: success() && github.ref == 'refs/heads/main'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Forzar la subida de la carpeta coverage
          git add -f coverage/
          
          # Hacer commit si hay cambios
          git commit -m "üìä Auto-update: Informe de cobertura [skip ci]" || echo "Sin cambios en cobertura"
          
          # Subir los cambios
          git push origin HEAD:main || echo "No se pudo hacer push"

  lint:
    name: An√°lisis de C√≥digo
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v4

      - name: üêò Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: php-cs-fixer, phpcs

      - name: üì¶ Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: üîç Verificar sintaxis PHP
        run: |
          echo "üîç Verificando sintaxis PHP..."
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; | grep -v "No syntax errors"
          echo "‚úÖ Sintaxis PHP correcta"
